steps:
  - command: |
      ## prepopulate if necessary
      if [ ! -d /nixstore/store ]; then
        cp -pur /nix/* /nixstore/
      fi
    timeout: 60
    label: ":pipeline: Prepopulate Nix Store"
    agents:
    - "queue=linux"
    plugins:
      - docker#v3.0.1:
          image: "nixorg/nix:latest"
          volumes:
            - "/var/lib/buildkite/nix:/nixstore"
  - wait
  - command: |
        echo --- Setup the Nix Package Manager
        nix-channel --add https://nixos.org/channels/nixpkgs-unstable nixpkgs && nix-channel --update

        nix-shell --run bash <<'NIXSH'
          echo --- Build spook
          make

          echo +++ Lint
          make lint

          echo +++ Test
          make test
        NIXSH

    label: ":pipeline: Build and Test"
    agents:
    - "queue=linux"
    timeout: 600
    plugins:
      - docker#v3.0.1:
          image: "nixorg/nix:latest"
          volumes:
            - "/var/lib/buildkite/nix:/nix"